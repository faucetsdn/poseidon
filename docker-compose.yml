version: '2'

services:
  api:
    image: poseidon-api
    container_name: poseidon-api
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - 12345:8080
  docs:
    image: poseidon-docs
    container_name: poseidon-docs
    build:
      context: .
      dockerfile: Dockerfile.docs
    ports:
      - 8000
  mock:
    image: mock-controller
    container_name: mock-controller
    build:
      context: .
      dockerfile: Dockerfile.mock
    environment:
      - ALLOW_ORIGIN = http://$DOCKER_URL:8111
    network_mode: "container:poseidon-monitor"
  monitor:
    depends_on:
      - api
    image: poseidon-monitor
    container_name: poseidon-monitor
    build:
      context: .
      dockerfile: Dockerfile.monitor
    ports:
      - 8000
    environment:
      - ALLOW_ORIGIN = http://$DOCKER_URL:12345
  main:
    image: poseidon-main
    container_name: poseidon-main
    build:
      context: .
      dockerfile: Dockerfile.main
    ports:
      - 8000
  storageWorkaround:
    # http://www.diogogmt.com/running-mongodb-with-docker-and-compose/
    container_name: poseidon-storageWorkaround
    image: mongo
    volumes:
      - /data/db
  storage:
    container_name: poseidon-storage
    image: mongo
    volumes_from:
      - storageWorkaround
    ports:
      - 27017
    command: --smallfiles --rest --auth
  periodically:
    image: poseidon-periodically
    container_name: poseidon-periodically
    build:
      context: .
      dockerfile: Dockerfile.periodically
    network_mode: "container:poseidon-monitor"
